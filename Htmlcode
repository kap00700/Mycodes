from fastapi import FastAPI, Request
from google.cloud import bigquery
import vertexai
from vertexai.language_models import TextGenerationModel
import json

app = FastAPI()

# Initialize clients
bq_client = bigquery.Client()
vertexai.init(project="YOUR_GCP_PROJECT", location="us-central1")
model = TextGenerationModel.from_pretrained("text-bison@002")

TABLE_NAME = "`project.dataset.airflow_task_runs`"

SCHEMA_PROMPT = """
Table: airflow_task_runs
Columns:
- dag_id STRING
- task_id STRING
- run_date DATE
- status STRING (RUNNING, SUCCESS, FAILED)
- start_time TIMESTAMP
- end_time TIMESTAMP

Rules:
1. Always generate valid BigQuery SQL.
2. Never use SELECT * unless user explicitly asks.
3. Always limit results to 20 unless asked otherwise.
"""

def generate_sql_from_question(user_question):
    prompt = f"""
    {SCHEMA_PROMPT}

    Convert this question into BigQuery SQL:
    Question: "{user_question}"
    """

    response = model.predict(prompt, max_output_tokens=512)
    return response.text.strip()

def run_bigquery(sql):
    df = bq_client.query(sql).to_dataframe()
    return df.to_dict(orient="records")

def summarize_result(user_question, data):
    prompt = f"""
    User asked: "{user_question}"

    BigQuery returned:
    {json.dumps(data, indent=2)}

    Summarize this result in simple human language.
    """

    response = model.predict(prompt, max_output_tokens=256)
    return response.text.strip()

@app.post("/chat")
async def chat(request: Request):
    body = await request.json()
    user_text = body["message"]["text"]

    # Step 1: Convert question â†’ SQL
    sql = generate_sql_from_question(user_text)

    # Step 2: Run SQL in BigQuery
    results = run_bigquery(sql)

    # Step 3: Summarize in English
    answer = summarize_result(user_text, results)

    return {"text": answer}